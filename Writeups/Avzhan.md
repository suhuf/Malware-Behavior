

Hello, today we are going to do a dynamic analysis of the behavior of the Avzhan Malware. There are multiple advanced write-ups available of this malware. Of the best of them, Malware Bytes as found here (https://www.malwarebytes.com/blog/news/2018/02/avzhan-ddos-bot-dropped-by-chinese-drive-by-attack).

**Run down of Avzhan:**

Avzhan is a malware, most likely released from China, that transforms its victims machines into DDoS bots. The behavior of the malware is compeltely restricted to the task of DDoS attacks and does not send passwords or do other malicious tasks other than this.

In this case, Avzhan when first run,, copies itself into System32 directory with a randomly generated 6 character name. Deletes its exe of origin and makes a new EXE that is used to take commands from its CNC (Command and Control center). 

It also runs a service via the windows API Under **Services/gtrey** that has a display name of **'Juyi'** (Static) and a description of **"Tuy"**. Now Let's get to some dynamic analysis.



**Regishot:**


We take our first regishot and then run the malware with admin priveledges and then compare...


**![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/60781f97-1960-4e09-a88e-af331cbc8375)
**

The first thing we notice is that the .Exe has deleted itself. This is common for malware so that it is more difficult to detect on the system. Usually, the malware will copy itself to another .EXE under a randomly generated name and start a service in order to mask its malicious intent/activity. Let's see if we can find where it put itself too:


We can check files added in regishot and we specifically see an .Exe that does not look like it is typical with Windows Systems:

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/0e8e4889-63bf-43bc-ae7e-26f619947284)

**Windows\Syswow64\Xonoo.exe**

This is the location that the exe has copied itself to, using a randomly generated name (Note that I had to re-run the malware more than once so this randomly generated name might be different later on in the paper).

Now let's see if we can find a service that it is using:

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/c460089f-6aed-464c-8002-5315809da8c4)


Now under **'gtey'**, an uncommon service name, we find a service that is directly using the suspicious .Exe we noted earlier. It has a Display name of 'juyi' and a description of 'tuy'. These are both statically named and as a result important to note as they could be Indicators of compromise on other systems.


Now That we we have more details on the service we can check for that service name later on regardless if the Exe has a different name.

Besides that there are some registry edits that are for persistence from the malware.


**Process Explorer:**

Now let's see a bit more of what the malware is doing on our system, when checking process explorer it was very difficult to locate the exe. However, once the network adapter was turned on (On host only) the exe immediately appeared in process explorer:


![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/73d5325d-1fe7-4fd2-be4b-09f1fa2b81e9)

(**Note:** it is a different randomly generated 6 characters as I re-ran the malware afetr reverting my snapshot)


We cna look for more info on this newly created .Exe here. 

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/9e215bfa-545e-4c91-bd91-70d7c39edba0)

We also can check the strings of the program via process explorer where we first find this:

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/bfc5c9e7-e79d-45bb-b8f3-7b876c0a5fd3)

This is a malformed Get request that is some times used in DoS attacks.


Looking further into the strings of the exe we have more evidence it has functioanlity to make http requests:

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/4ec9f7bc-d831-464a-baae-73068e6c29a1)

We can see it spoofs its referer, user agent, and other details. Of interesting note is that it's default language is also chinese. 

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/a9c2cda0-840a-49c6-96b6-fcae016eb040)

However, with all of this we still are unable to indentify a static IP Addres string.

Looking further in the strings however we do find some very important information:

![image](https://github.com/suhuf/Malware-Behavior/assets/105312929/b2f7c6dd-6ac7-4d73-af7d-dc102ed5420b)

Firstly, we find a host name that the malware refers to **'xhsb.3322.org'**. We also find functionality that allows the malware to downlaod a URL to a file **'URLDownloadToFileA'**.

Now that we have a host name we can look further into the malware's behavior on the networking side.


More info on 'xhsb.3322.org'; this was a famous Chinese DNS server that was commonly used by botnets and other malware. There was a huge number of bots that relied on this server to resolve DNS requests. This server was 'Controversially' taken down by Microsoft in around 2012. You can read more about it here: (https://circleid.com/posts/20120917_microsoft_takedown_of_3322_org_a_gigantic_self_goal) (https://krebsonsecurity.com/2012/09/malware-dragnet-snags-millions-of-infected-pcs/).


**Networking Portion**


**[Networking Setup]**

Here, I am going to run 2 Vms at once both on host only. VMware has designed its network to work that when 2 VMs are running on host only that they can communciate with each other as long as they are on the same Subnet. To this yourself, set your windows VM to be on the same subnet as your other DNS spoofing box and then test connectivity via ping. Instructions for Ubuntu disributions are provided here: https://www.freecodecamp.org/news/setting-a-static-ip-in-ubuntu-linux-ip-address-tutorial/ .


In this case we are going to be using FakeDns(.py) on Remnux. As a result, everything that attempts to communicate from the Windows VM is going to be sent to the Remnux box **including** Windows telemetry.

The network settings on the Windows VM need to have **1. Same Subnet** **2. Its Default gateway as the IP of the other VM.**

If you are able to ping both machines back and forth you should be good.


**[Networking Analysis]**

On the host VM we can use a tool developed by Mike Murr that also comes pre-installed on Remnux called **"FakeDNS(.py)"** this lets our Remnux VM spoof as a DNS server and also resolve requests to itself:

TBC




























